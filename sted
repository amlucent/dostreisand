#!/usr/bin/env bash
PLAYBOOK_PORT="${PLAYBOOK_PORT:-22}"
DEBUG_MODE="${DEBUG_MODE:-'no'}"
doimagename="hwdm/dostreisand"
if docker images | sed '1d' | awk '{print $1}' | grep -iq "${doimagename}"; then
    echo "${doimagename} docker image is ready. We're going to run it."
else
    echo "${doimagename} doesn't exist. We're going to run: docker pull ${doimagename}"
    docker pull ${doimagename} && echo "${doimagename} is ready. We're going to run it."
fi

if [ $# -lt 1 ];then
    echo "We're going to run ${doimagename} as streisand cli:"
    echo "Please specify the SSH keypair name either in ~/.ssh or in ./ssh! like: ./sted keypairname"
    echo "If a ./streisand OR ./playbooks dir exists, it will be mounted for code/config customization"
    echo "DEBUG_MODE is ${DEBUG_MODE}, export DEBUG_MODE='yes' before running this script if you wanna print host vars."
    echo "PLAYBOOK_PORT is ${PLAYBOOK_PORT}, export PLAYBOOK_PORT=newport before running this script if you wanna change."
    exit 0
else
    exec > >(tee $(pwd)/sted.log )
    exec 2> >(tee -a $(pwd)/sted.log >&2)
    if [ ! -d "$(pwd)/serv" ]; then
        mkdir -p "$(pwd)/serv"
    fi
    if [ -f "${HOME}/.ssh/${1}.pem" ] && [ -f "${HOME}/.ssh/${1}.pub" ]; then
        ssh_prvkey="${HOME}/.ssh/${1}.pem"
        ssh_pubkey="${HOME}/.ssh/${1}.pub"
        echo "Use existing keypair ${1} in ${HOME}/.ssh"
    elif [ -f "$(pwd)/serv/sshkey/id_rsa" ] && [ -f "$(pwd)/serv/sshkey/id_rsa.pub" ]; then
        ssh_prvkey="$(pwd)/serv/sshkey/id_rsa"
        ssh_pubkey="$(pwd)/serv/sshkey/id_rsa.pub"
        echo "Use existing keypair in $(pwd)/serv/sshkey which ought to be autogenerated remote sshkey ${1}."
    else
        echo "No exsitng keypair is found. It will be auto generated."
    fi
fi

echo "Running ${doimagename} as streisand cli:<Ctrl+C/Ctrl+D to terminate>"

## Create a data container:
## The ${doimagename} image declares the following two volume mounts:
## /root/.ssh/ streisand expects your provider's default ssh key, here saved as id_rsa.pub
## /streisand/generated-docs/ upon completion, streisand will publish connection information in this directory as html files.
sudo docker rm -f streisand-data 2>/dev/null
sudo docker rm -f streisand-key 2>/dev/null
sudo docker rm -f streisand-cli 2>/dev/null
## This is the SSH key registered on your provider (Digitalocean) that new VMs are bootstrapped with.
if [ -f "${ssh_pubkey}" ] && [ -f "${ssh_prvkey}" ]; then
    echo "docker run --name streisand-data ${doimagename}"
    if [ -d "$(pwd)/streisand" ]; then
        echo "Mounting $(pwd)/streisand and $(dirname ${ssh_pubkey}) to streisand-data container"
        sudo docker run --name streisand-data -v $(pwd)/serv:/serv -v $(pwd)/streisand:/streisand -v ${ssh_prvkey}:/root/.ssh/id_rsa -v ${ssh_pubkey}:/root/.ssh/id_rsa.pub ${doimagename}
    elif [ -d "$(pwd)/playbooks" ]; then
        echo "Mounting $(pwd)/playbooks and $(dirname ${ssh_pubkey}) to streisand-data container"
        sudo docker run --name streisand-data -v $(pwd)/serv:/serv -v $(pwd)/playbooks:/streisand/playbooks -v ${ssh_prvkey}:/root/.ssh/id_rsa -v ${ssh_pubkey}:/root/.ssh/id_rsa.pub ${doimagename}
    else
        sudo docker run --name streisand-data -v $(pwd)/serv:/serv -v ${ssh_prvkey}:/root/.ssh/id_rsa -v ${ssh_pubkey}:/root/.ssh/id_rsa.pub ${doimagename}
    fi
    echo "Backing up the used ssh keypairs to $(pwd)/serv ..."
    sudo docker run --rm --volumes-from=streisand-data -v $(pwd):/output ${doimagename} cp -rf /root/.ssh /output/serv/sshkey 2>/dev/null
    ## Execute streisand:
    echo "docker run -it --rm --name streisand-cli -e DEBUG_MODE=${DEBUG_MODE} -e PLAYBOOK_PORT=${PLAYBOOK_PORT} --volumes-from=streisand-data ${doimagename}"
    sudo docker run -it --rm --name streisand-cli -e DEBUG_MODE=${DEBUG_MODE} -e PLAYBOOK_PORT=${PLAYBOOK_PORT} --volumes-from=streisand-data ${doimagename}
else
    echo "docker run --name streisand-data ${doimagename}"
    if [ -d "$(pwd)/streisand" ]; then
        sudo docker run --name streisand-data -v $(pwd)/serv:/serv -v $(pwd)/streisand:/streisand ${doimagename}
    elif [ -d "$(pwd)/playbooks" ]; then
        sudo docker run --name streisand-data -v $(pwd)/serv:/serv -v $(pwd)/playbooks:/streisand/playbooks ${doimagename}
    else
        sudo docker run --name streisand-data -v $(pwd)/serv:/serv ${doimagename}
    fi
    ## Generate a new default SSH key if they doesn't exist:
    echo "docker run -it --rm --volumes-from=streisand-data ${doimagename} ssh-keygen -t rsa -b 4096 -f /root/.ssh/id_rsa -N ''"
    sudo docker run -it --rm --name streisand-key --volumes-from=streisand-data ${doimagename} ssh-keygen -t rsa -b 4096 -f /root/.ssh/id_rsa -N ''
    echo "Dumping the auto generated ssh keypairs to $(pwd)/serv ..."
    sudo docker run --rm --volumes-from=streisand-data -v $(pwd):/output ${doimagename} cp -rf /root/.ssh /output/serv/sshkey 2>/dev/null

    ## Execute streisand:
    echo "docker run -it --rm --name streisand-cli -e DEBUG_MODE=${DEBUG_MODE} -e PLAYBOOK_PORT=${PLAYBOOK_PORT} --volumes-from=streisand-data ${doimagename}"
    sudo docker run -it --rm --name streisand-cli -e DEBUG_MODE=${DEBUG_MODE} -e PLAYBOOK_PORT=${PLAYBOOK_PORT} --volumes-from=streisand-data ${doimagename}
fi
## Retrieve generated docs:
sudo docker run --rm --volumes-from=streisand-data -v $(pwd):/output ${doimagename} cp -rf /streisand/generated-docs /output/docs 2>/dev/null
sudo docker rm -f streisand-data 2>/dev/null
## Generated docs can now be found at ./generated-docs/streisand.html.

